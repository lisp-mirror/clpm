variables:
  GIT_SUBMODULE_STRATEGY: recursive
  ALPINE_VERSION: "3.13"
  DEBIAN_VERSION: stretch
  SBCL_VERSION: 2.1.1
  DOCKER_HUB_CI_REPO: daewok/clpm-ci

include:
  - template: 'Workflows/MergeRequest-Pipelines.gitlab-ci.yml'

stages:
  - prep
  - build

##############################################################################
# Build Docker images for CI
##############################################################################

.alpine-image:
  stage: prep
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      /kaniko/executor --cache --cache-repo $CI_REGISTRY_IMAGE/kaniko \
                       --context $CI_PROJECT_DIR \
                       --build-arg sbcl_version=$SBCL_VERSION \
                       --build-arg alpine_version=$ALPINE_VERSION \
                       --dockerfile $CI_PROJECT_DIR/docker/Dockerfile.alpine-ci \
                       --destination $CI_REGISTRY_IMAGE/ci:$SBCL_VERSION-alpine$ALPINE_VERSION-$ARCH
  rules:
    - if: '$CI_PROJECT_NAMESPACE == "clpm"'

.debian-image:
  stage: prep
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - |
      /kaniko/executor --cache --cache-repo $CI_REGISTRY_IMAGE/kaniko \
                       --context $CI_PROJECT_DIR \
                       --build-arg sbcl_version=$SBCL_VERSION \
                       --build-arg debian_version=$DEBIAN_VERSION \
                       --dockerfile $CI_PROJECT_DIR/docker/Dockerfile.debian-ci \
                       --destination $CI_REGISTRY_IMAGE/ci:$SBCL_VERSION-$DEBIAN_VERSION-$ARCH
  rules:
    - if: '$CI_PROJECT_NAMESPACE == "clpm"'

alpine-image:amd64:
  extends: .alpine-image
  variables:
    ARCH: amd64

alpine-image:arm64:
  extends: .alpine-image
  variables:
    ARCH: arm64
  tags:
    - arm64

debian-image:amd64:
  extends: .debian-image
  variables:
    ARCH: amd64

debian-image:arm64:
  extends: .debian-image
  variables:
    ARCH: arm64
  tags:
    - arm64

##############################################################################
# Build static releases
##############################################################################

.static-release:
  stage: build
  image: $CI_REGISTRY_IMAGE/ci:$SBCL_VERSION-alpine$ALPINE_VERSION-$ARCH
  before_script:
    - git checkout -B $CI_COMMIT_BRANCH $CI_COMMIT_SHA
  script:
    - sbcl --script scripts/build-release.lisp --static
  artifacts:
    paths:
      - releases/
  rules:
    - if: '$CI_COMMIT_BRANCH'

static-release:linux:amd64:
  extends: .static-release
  variables:
    ARCH: amd64

static-release:linux:arm64:
  extends: .static-release
  variables:
    ARCH: arm64
  tags:
    - arm64

##############################################################################
# Build dynamic releases
##############################################################################

.dynamic-release:
  stage: build
  image: $CI_REGISTRY_IMAGE/ci:$SBCL_VERSION-$DEBIAN_VERSION-$ARCH
  before_script:
    - git checkout -B $CI_COMMIT_BRANCH $CI_COMMIT_SHA
  script:
    - sbcl --script scripts/build-release.lisp
  artifacts:
    paths:
      - releases/
  rules:
    - if: '$CI_COMMIT_BRANCH'

dynamic-release:linux:amd64:
  extends: .dynamic-release
  variables:
    ARCH: amd64

dynamic-release:linux:arm64:
  extends: .dynamic-release
  variables:
    ARCH: arm64
  tags:
    - arm64

# dynamic-release:linux:armv7:
#   extends: .dynamic-release
#   variables:
#     ARCH: armhf
#   tags:
#     - armv7

dynamic-release:macos:amd64:
  stage: build
  extends: .dynamic-release
  tags:
    - macos-0.4-amd64

dynamic-release:windows:amd64:
  image: $DOCKER_HUB_CI_REPO:$SBCL_VERSION-windowsservercore
  variables:
    GIT_STRATEGY: clone
    GIT_SUBMODULE_STRATEGY: none
    GIT_CHECKOUT: "false"
  before_script:
    - git checkout -B $CI_COMMIT_BRANCH $CI_COMMIT_SHA
    - git submodule init
    - git submodule update
  script:
    - $env:WIX = "C:\wix"
    - sbcl --script scripts/build-release.lisp
    - sbcl --script scripts/build-msi.lisp
  artifacts:
    paths:
      - releases/
  rules:
    - if: '$CI_COMMIT_BRANCH'
  tags:
    - windows-amd64
